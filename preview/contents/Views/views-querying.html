<!DOCTYPE html><html xmlns:related-links="http://dita-ot.sourceforge.net/ns/200709/related-links" class="no-js developer-portal" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Querying views</title><meta name="apple-mobile-web-app-title" content="Couchbase"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png"><link rel="stylesheet" href="../assets/stylesheets/application.css"><link rel="stylesheet" href="../assets/stylesheets/docs.css"></head><body data-modules="developer-portal-sidebar-navigation developer-portal-versions-navigation"><header class="developer-portal-header" role="banner"><div class="layout-wrapper"><div class="developer-portal-header__hgroup"><h1 class="developer-portal-header__logo"><a href="http://couchbase.com" rel="home">Couchbase</a></h1><p class="developer-portal-header__page-title">Couchbase Server</p></div><nav class="developer-portal-header__navigation" id="primary-navigation" role="navigation"><div class="developer-portal-header__navigation__wrapper" id="primary-navigation__wrapper"><a href="http://www.couchbase.com/learn" class="developer-porta-header__navigation__back">
							Return to Learn
						</a><ul class="developer-portal-header__navigation__items"><li class="developer-portal-header__navigation__item"><a href="/developer">Developer Documentation</a></li><li class="developer-portal-header__navigation__item"><a href="http://developer.couchbase.com/mobile">Couchbase Mobile</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/open-source">Open Source Projects</a></li><li class="developer-portal-header__navigation__item"><a href="http://forums.couchbase.com">Forums</a></li><li class="developer-portal-header__navigation__item"><a href="http://docs.couchbase.com/archive-index">Documentation Archives</a></li></ul><div class="developer-portal-header__search"></div></div></nav></div></header><main class="developer-portal-global-content" role="main"><aside class="developer-portal-sidebar"><div class="developer-portal-sidebar__versions"><ul id="developer-portal-versions-navigation"><li class="active"><a href="#"><span>Version 3.0</span></a></li><li class=""><a href="http://docs.couchbase.com/archive-index"><span>Older</span></a></li></ul></div><nav class="developer-portal-sidebar__navigation"><div class="developer-portal-sidebar__navigation__wrapper" id="developer-portal-sidebar-navigation"><ul><li class="section section--has-sub-sections"><a href="../Couchbase-intro.html"><span>はじめに</span></a></li><li class="section"><a href="../Whats-new-3.0.html"><span>3.0の新機能</span></a></li><li class="section section--has-sub-sections"><a href="../install-intro.html"><span>インストールとアップグレード</span></a></li><li class="section section--has-sub-sections"><a href="../admin-intro.html"><span>Couchbase Serverの管理</span></a></li><li class="section section--has-sub-sections section--active"><a href="../Views/views-intro.html"><span>Views and indexes</span></a><ul class="sub-sections"><li class="section"><a href="../Views/views-basics.html"><span>View basics</span></a></li><li class="section"><a href="../Views/views-index-updates.html"><span>ストリームベースのView</span></a></li><li class="section"><a href="../Views/views-operation.html"><span>Views operations</span></a></li><li class="section"><a href="../Views/views-storedData.html"><span>Views and stored data</span></a></li><li class="section"><a href="../Views/views-development.html"><span>Development views</span></a></li><li class="section"><a href="../Views/views-production.html"><span>Production views</span></a></li><li class="section"><a href="../Views/views-writing.html"><span>Writing views</span></a></li><li class="section"><a href="../Views/views-geospatial.html"><span>Writing geospatial views</span></a></li><li class="section"><a href="../Views/views-schemaless.html"><span>Views in a schema-less database</span></a></li><li class="section"><a href="../Views/views-translateSQL.html"><span>Translating SQL to map/reduce</span></a></li><li class="section"><a href="../Views/views-querying.html" class="current"><span>Querying views</span></a><ul class="sub-sections"></ul></li><li class="section"><a href="../Views/views-querySample.html"><span>View and query examples</span></a></li><li class="section section--has-sub-sections"><a href="../Misc/sample-bucket-intro.html"><span>Sample buckets</span></a></li></ul></li><li class="section section--has-sub-sections"><a href="../cli-intro.html"><span>CLIリファレンス</span></a></li><li class="section section--has-sub-sections"><a href="../rest-intro.html"><span>REST APIリファレンス</span></a></li><li class="section section--has-sub-sections"><a href="../rel-notes/rel-notes3.0.html"><span>Release notes</span></a></li></ul></div></nav></aside><div class="developer-portal-content"><div class="developer-portal-content__wrapper textblock__content">
   <h1 class="title topictitle1">Querying views</h1>

   
   <div class="body"><p class="shortdesc">The content of the key that is generated by the <samp class="ph codeph">emit()</samp> function provides information on
      how the data is selected from your view.</p>

      <p class="p">In order to query a view, the view definition must include a suitable map function that
         uses the <samp class="ph codeph">emit()</samp> function to generate each row of information. </p>

      <p class="p">The key can be used when querying a view as the selection mechanism, either by using
         an:</p>

      <ul class="ul">
         <li class="li"><p class="p"><em class="ph i">explicit key</em> — show all the records matching the exact structure of the
               supplied key.</p>
</li>

         <li class="li"><p class="p"><em class="ph i">list of keys</em> — show all the records matching the exact structure of each of
               the supplied keys (effectively showing keya or keyb or keyc).</p>
</li>

         <li class="li"><p class="p"><em class="ph i">range of keys</em> — show all the records starting with keyA and stopping on the last instance
               of keyB.</p>
</li>

      </ul>

      <p class="p">When querying the view results, a number of parameters can be used to select, limit, order
         and otherwise control the execution of the view and the information that is returned.</p>

      <p class="p">When a view is accessed without specifying any parameters, the view will produce results
         matching the following:</p>

      <ul class="ul">
         <li class="li"><p class="p">Full view specification, i.e. all documents are potentially output according to the
               view definition.</p>
</li>

         <li class="li"><p class="p">Limited to 10 items within the Admin Console, unlimited through the REST
            API.</p>
</li>

         <li class="li"><p class="p">Reduce function used if defined in the view.</p>
</li>

         <li class="li"><p class="p">Items sorted in ascending order (using UTF–8 comparison for strings, natural number
               order)</p>
</li>

      </ul>

      <p class="p">View results and the parameters operate and interact in a specific order. The interaction
         directly affects how queries are written and data is selected.</p>

      
      <div class="fig fignone">
            <img class="image" src="../images/views-query-flow.png" width="480" alt="">
         </div>

      
      <p class="p">The core arguments and selection systems are the same through both the REST API interface,
         and the client libraries. The setting of these values differs between different client
         libraries, but the argument names and expected and supported values are the same across all
         environments.</p>

      
      
      
      <div class="section"><h2 class="title sectiontitle">Querying</h2><p class="p">Querying can be performed through the REST API endpoint.
            The REST API supports and operates using the core HTTP protocol, and this is the same
            system used by the client libraries to obtain the view data.</p>
 To retrieve views
         information, access any server node in a cluster on port 8092. <p class="p">The following is the HTTP
            method and URI used to query
            views:</p>
<pre class="pre codeblock"><code>GET /[bucket-name]/_design/[ddoc-name]/_view/[view-name]</code></pre>
<p class="p">Where:</p>
<ul class="ul">
            <li class="li">bucket-name is the name of the bucket.</li>

            <li class="li">ddoc-name is the name of the design document that contains the view.</li>

            <li class="li">view-name is the name of the corresponding view within the design document.</li>

         </ul>
<p class="p">Development view, the <samp class="ph codeph">ddoc-name</samp> is prefixed with
               <samp class="ph codeph">dev_</samp>. For example, the design document <samp class="ph codeph">beer</samp> is
            accessible as a development view using <samp class="ph codeph">dev_beer</samp>.</p>
<p class="p">Production views
            are accessible using their name only.</p>

         <p class="p">Parameters (optional):</p>

         
<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" class="table" frame="border" border="1" rules="all"><caption><span class="tablecap">Table 1. Views parameters</span></caption>
               
               
               
               <thead class="thead" align="left">
                  <tr class="row">
                     <th class="entry" valign="top" width="16.778523489932887%" id="d135094e149">Parameters</th>

                     <th class="entry" valign="top" width="16.778523489932887%" id="d135094e152">Type</th>

                     <th class="entry" valign="top" width="66.44295302013423%" id="d135094e155">Description</th>

                  </tr>

               </thead>

               <tbody class="tbody">
                  <tr class="row">
                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e149 "><samp class="ph codeph">descending</samp></td>

                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e152 ">boolean</td>

                     <td class="entry" valign="top" width="66.44295302013423%" headers="d135094e155 ">Return the documents in descending by key order.</td>

                  </tr>

                  <tr class="row">
                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e149 "><samp class="ph codeph">endkey</samp></td>

                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e152 ">string</td>

                     <td class="entry" valign="top" width="66.44295302013423%" headers="d135094e155 ">Stop returning records when the specified key is reached. Key must be
                        specified as a JSON value.</td>

                  </tr>

                  <tr class="row">
                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e149 "><samp class="ph codeph">endkey_docid</samp></td>

                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e152 ">string</td>

                     <td class="entry" valign="top" width="66.44295302013423%" headers="d135094e155 ">Stop returning records when the specified document ID is
                        reached.</td>

                  </tr>

                  <tr class="row">
                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e149 "><samp class="ph codeph">full_set</samp></td>

                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e152 ">boolean</td>

                     <td class="entry" valign="top" width="66.44295302013423%" headers="d135094e155 ">Use the full cluster data set (development views only).</td>

                  </tr>

                  <tr class="row">
                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e149 "><samp class="ph codeph">group</samp></td>

                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e152 ">boolean</td>

                     <td class="entry" valign="top" width="66.44295302013423%" headers="d135094e155 ">Group the results using the reduce function to a group or single row.
                        Note: Do not use <samp class="ph codeph">group</samp> with <samp class="ph codeph">group_level</samp>
                        because they are not compatible.</td>

                  </tr>

                  <tr class="row">
                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e149 "><samp class="ph codeph">group_level</samp></td>

                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e152 ">numeric</td>

                     <td class="entry" valign="top" width="66.44295302013423%" headers="d135094e155 ">Specify the group level to be used. Note: Do not use
                           <samp class="ph codeph">group_level</samp> with <samp class="ph codeph">group</samp> because they are
                        not compatible.</td>

                  </tr>

                  <tr class="row">
                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e149 "><samp class="ph codeph">inclusive_end</samp></td>

                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e152 ">boolean</td>

                     <td class="entry" valign="top" width="66.44295302013423%" headers="d135094e155 ">Specifies whether the specified end key is included in the result. Note:
                        Do not use <samp class="ph codeph">inclusive_end</samp> with <samp class="ph codeph">key</samp> or
                           <samp class="ph codeph">keys</samp>.</td>

                  </tr>

                  <tr class="row">
                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e149 "><samp class="ph codeph">key</samp></td>

                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e152 ">string</td>

                     <td class="entry" valign="top" width="66.44295302013423%" headers="d135094e155 ">Return only documents that match the specified key. Key must be
                        specified as a JSON value.</td>

                  </tr>

                  <tr class="row">
                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e149 "><samp class="ph codeph">keys</samp></td>

                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e152 ">array</td>

                     <td class="entry" valign="top" width="66.44295302013423%" headers="d135094e155 ">Return only documents that match each of keys specified within the given
                        array. Key must be specified as a JSON value. Sorting is not applied when
                        using this option.</td>

                  </tr>

                  <tr class="row">
                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e149 "><samp class="ph codeph">limit</samp></td>

                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e152 ">numeric</td>

                     <td class="entry" valign="top" width="66.44295302013423%" headers="d135094e155 ">Limit the number of the returned documents to the specified
                        number.</td>

                  </tr>

                  <tr class="row">
                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e149 "><samp class="ph codeph">on_error</samp></td>

                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e152 ">string</td>

                     <td class="entry" valign="top" width="66.44295302013423%" headers="d135094e155 ">Sets the response in the event of an error. <div class="p">Supported values: <ul class="ul">
                              <li class="li"><samp class="ph codeph">continue</samp> : Continue to generate view information
                                 in the event of an error, including the error information in the
                                 view response stream.</li>

                              <li class="li"><samp class="ph codeph">stop</samp> : Stop immediately when an error condition
                                 occurs. No further view information is returned.</li>

                           </ul>
</div>

                     </td>

                  </tr>

                  <tr class="row">
                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e149 "><samp class="ph codeph">reduce</samp></td>

                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e152 ">boolean</td>

                     <td class="entry" valign="top" width="66.44295302013423%" headers="d135094e155 ">Use the reduction function.</td>

                  </tr>

                  <tr class="row">
                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e149 "><samp class="ph codeph">skip</samp></td>

                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e152 ">numeric</td>

                     <td class="entry" valign="top" width="66.44295302013423%" headers="d135094e155 ">Skip this number of records before starting to return the
                        results.</td>

                  </tr>

                  <tr class="row">
                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e149 "><samp class="ph codeph">stale</samp></td>

                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e152 ">string</td>

                     <td class="entry" valign="top" width="66.44295302013423%" headers="d135094e155 ">Allow the results from a stale view to be used. <div class="p">Supported values: <ul class="ul">
                              <li class="li"><samp class="ph codeph">false</samp> : The server waits for the indexer to
                                 finish the changes that correspond to the current key-value
                                 document set and then returns the latest entries from the view
                                 index.</li>

                              <li class="li"><samp class="ph codeph">ok</samp> : The server returns the current entries from
                                 the index file including the stale views.</li>

                              <li class="li"><samp class="ph codeph">update_after</samp> : The server returns the current
                                 entries from the index, and then initiates an index update.</li>

                           </ul>
</div>
</td>

                  </tr>

                  <tr class="row">
                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e149 "><samp class="ph codeph">startkey</samp></td>

                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e152 ">string</td>

                     <td class="entry" valign="top" width="66.44295302013423%" headers="d135094e155 ">Return records with a value equal to or greater than the specified key.
                        Key must be specified as a JSON value.</td>

                  </tr>

                  <tr class="row">
                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e149 "><samp class="ph codeph">startkey_docid</samp></td>

                     <td class="entry" valign="top" width="16.778523489932887%" headers="d135094e152 ">string</td>

                     <td class="entry" valign="top" width="66.44295302013423%" headers="d135094e155 ">Return records starting with the specified document ID.</td>

                  </tr>

               </tbody>

            </table>
</div>

         <p class="p">Curl request syntax:</p>

         <pre class="pre codeblock"><code>GET http://[localhost]:8092/[bucket-name]/_design/[ddoc-name]/_view/[view-name]</code></pre>

         <p class="p">To access a view stored within an SASL password-protected bucket, include the bucket
            name and bucket password within the URL of the request:</p>

         <pre class="pre codeblock"><code>GET http://[bucket-name]:[password]@[localhost]:8092/[bucket-name]/_design/[ddoc-name]/_view/[view-name]
</code></pre>

         <div class="note note"><span class="notetitle">Note:</span> Additional arguments to the URL request can be used to select information
            from the view, and provide limit, sorting and other options.</div>

         <p class="p">To output only ten items:</p>

         <pre class="pre codeblock"><code>GET http://[localhost]:8092/[bucket-name]/_design/[ddoc-name]/_view/[view-name]?limit=10
</code></pre>

         <div class="note important"><span class="importanttitle">Important:</span> The formatting of the URL follows the HTTP specification. The first
            argument is separated from the base URL using a question mark ( <samp class="ph codeph">?</samp> ).
            Additional arguments are separated using an ampersand ( <samp class="ph codeph">&amp;</samp> ).
            Special characters are quoted or escaped according to the HTTP standard rules.</div>

      </div>

      
      
      
      <div class="section"><h2 class="title sectiontitle">Selecting information</h2><p class="p">Couchbase Server supports a number of
            mechanisms for selecting information returned by the view. Key selection is made after
            the view results (including the reduction function) are executed, and after the items in
            the view output have been sorted.</p>
<p class="p">When specifying keys to the selection mechanism,
            the key must be expressed in the form of a JSON value. For example, when specifying a
            single key, a string must be quoted (“string”).</p>
<p class="p">When specifying the key selection
            through a parameter, the keys must match the format of the keys emitted by the view.
            Compound keys, for example where an array or hash has been used in the emitted key
            structure, the supplied selection value should also be an array or a hash.</p>
<p class="p">The
            following selection types are supported:</p>
<ul class="ul">
            <li class="li"><strong class="ph b">Explicit Key</strong></li>

         </ul>
<p class="p">An explicit key can be specified using the parameter <samp class="ph codeph">key</samp>. The view
            query will only return results where the key in the view output, and the value supplied
            to the <samp class="ph codeph">key</samp> parameter match identically.</p>
<p class="p">For example, if you
            supply the value “tomato” only records matching <em class="ph i">exactly</em> “tomato” will be selected
            and returned. Keys with values such as “tomatoes” will not be returned.</p>
<ul class="ul">
            <li class="li"><strong class="ph b">Key List</strong></li>

         </ul>
<p class="p">A list of keys to be output can be specified by supplying an array of values using
            the <samp class="ph codeph">keys</samp> parameter. In this instance, each item in the specified array
            will be used as explicit match to the view result key, with each array value being
            combined with a logical <samp class="ph codeph">or</samp>.</p>
<p class="p">For example, if the value specified
            to the <samp class="ph codeph">keys</samp> parameter was <samp class="ph codeph">["tomato","avocado"]</samp>, then
            all results with a key of ‘tomato’ <em class="ph i">or</em> ‘avocado’ will be returned.</p>
<p class="p">When
            using this query option, the output results are not sorted by key. This is because key
            sorting of these values would require collating and sorting all the rows before
            returning the requested information.</p>
<p class="p">In the event of using a compound key, each
            compound key must be specified in the query. For example:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">```
keys=[["tomato",20],["avocado",20]]
```
</samp></code></pre>
<ul class="ul">
            <li class="li"><strong class="ph b">Key Range</strong></li>

         </ul>
<p class="p">A key range, consisting of a <samp class="ph codeph">startkey</samp> and <samp class="ph codeph">endkey</samp>.
            These options can be used individually, or together, as
            follows:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">* `startkey` only

  Output does not start until the first occurrence of `startkey`, or a value
  greater than the specified value, is seen. Output will then continue until the
  end of the view.

* `endkey` only

  Output starts with the first view result, and continues until the last
  occurrence of `endkey`, or until the emitted value is greater than the computed
  lexical value of `endkey`.

* `startkey` and `endkey`

  Output of values does not start until `startkey` is seen, and stops when the
  last occurrence of `endkey` is identified.
</samp></code></pre>
<p class="p">When
            using <samp class="ph codeph">endkey</samp>, the <samp class="ph codeph">inclusive_end</samp> option specifies
            whether output stops after the last occurrence of the specified <samp class="ph codeph">endkey</samp>
            (the default). If set to false, output stops on the last result before the specified
               <samp class="ph codeph">endkey</samp> is seen.</p>
<p class="p">The matching algorithm works on partial
            values, which can be used to an advantage when searching for ranges of keys.</p>

         
         <div class="note note"><span class="notetitle">Note:</span> Do not use the <samp class="ph codeph">inclusive_end</samp> parameter with <samp class="ph codeph">key</samp> 
            or <samp class="ph codeph">keys</samp> parameters. 
            The <samp class="ph codeph">inclusive_end</samp> parameter is not designed to work with <samp class="ph codeph">key</samp> 
            or <samp class="ph codeph">keys</samp> because it is an attribute of range operations.</div>

      
      
      </div>

      
      
      
      <div class="section"><h2 class="title sectiontitle">Selecting compound information by key or keys</h2><p class="p">If you are generating
            a compound key within your view, for example when outputting a date split into
            individually year, month, day elements, then the selection value must exactly match the
            format and size of your compound key. The value of <samp class="ph codeph">key</samp> or
               <samp class="ph codeph">keys</samp> must exactly match the output key structure.</p>

         
         
         <p class="p">For example,
            with the view
            data:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">{"total_rows":5693,"rows":[
{"id":"1310653019.12667","key":[2011,7,14,14,16,59],"value":null},
{"id":"1310662045.29534","key":[2011,7,14,16,47,25],"value":null},
{"id":"1310668923.16667","key":[2011,7,14,18,42,3],"value":null},
{"id":"1310675373.9877","key":[2011,7,14,20,29,33],"value":null},
{"id":"1310684917.60772","key":[2011,7,14,23,8,37],"value":null},
{"id":"1310693478.30841","key":[2011,7,15,1,31,18],"value":null},
{"id":"1310694625.02857","key":[2011,7,15,1,50,25],"value":null},
{"id":"1310705375.53361","key":[2011,7,15,4,49,35],"value":null},
{"id":"1310715999.09958","key":[2011,7,15,7,46,39],"value":null},
{"id":"1310716023.73212","key":[2011,7,15,7,47,3],"value":null}
]
}
</samp></code></pre>
<p class="p">Using
            the <samp class="ph codeph">key</samp> selection mechanism you must specify the entire key value,
            i.e.:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">?key=[2011,7,15,7,47,3]
</samp></code></pre>
<p class="p">If you
            specify a value, such as only the
            date:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">?key=[2011,7,15]
</samp></code></pre>
<p class="p">The view will
            return no records, since there is no exact key match. Instead, you must use a range that
            encompasses the information range you want to
            output:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">?startkey=[2011,7,15,0,0,0]&amp;endkey=[2011,7,15,99,99,99]
</samp></code></pre>
<p class="p">This
            will output all records within the specified range for the specified date. </p>
</div>

      
      
      
      <div class="section"><h2 class="title sectiontitle">Partial selection and key ranges</h2><p class="p">Matching of the key value has a
            precedence from right to left for the key value and the supplied
               <samp class="ph codeph">startkey</samp> and/or <samp class="ph codeph">endkey</samp>. Partial strings may
            therefore be specified and return specific information.</p>
<p class="p">For example, given the
            view
            data:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">"a",
 "aa",
 "bb",
 "bbb",
 "c",
 "cc",
 "ccc"
 "dddd"
</samp></code></pre>
<p class="p">Specifying
            a <samp class="ph codeph">startkey</samp> parameter with the value “aa” will return the last seven
            records, including
            “aa”:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">"aa",
 "bb",
 "bbb",
 "c",
 "cc",
 "ccc",
 "dddd"
</samp></code></pre>
<p class="p">Specifying
            a partial string to <samp class="ph codeph">startkey</samp> will trigger output of the selected values
            as soon as the first value or value greater than the specified value is identified. For
            strings, this partial match (from left to right) is identified. For example, specifying
            a <samp class="ph codeph">startkey</samp> of “d” will
            return:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">"dddd"
</samp></code></pre>
<p class="p">This is because the first
            match is identified as soon as the a key from a view row matches the supplied
               <samp class="ph codeph">startkey</samp> value <em class="ph i">from left to right</em>. The supplied single
            character matches the first character of the view output.</p>
<p class="p">When comparing larger
            strings and compound values the same matching algorithm is used. For example, searching
            a database of ingredients and specifying a <samp class="ph codeph">startkey</samp> of “almond” will
            return all the ingredients, including “almond”, “almonds”, and “almond
            essence”.</p>
<p class="p">To match all of the records for a given word or value across the entire
            range, you can use the null value in the <samp class="ph codeph">endkey</samp> parameter. For example,
            to search for all records that start only with the word “almond”, you specify a
               <samp class="ph codeph">startkey</samp> of “almond”, and an endkey of “almond\u02ad” (i.e. with the
            last Latin character at the end). If you are using Unicode strings, you may want to use
            “\uefff”.</p>
<pre class="pre codeblock"><code><samp class="ph codeph">startkey="almond"&amp;endkey="almond\u02ad"
</samp></code></pre>
<p class="p">The
            precedence in this example is that output starts when ‘almond’ is seen, and stops when
            the emitted data is lexically greater than the supplied <samp class="ph codeph">endkey</samp>.
            Although a record with the value “almond\02ad” will never be seen, the emitted data will
            eventually be lexically greater than “almond\02ad” and output will stop.</p>
<p class="p">In
            effect, a range specified in this way acts as a prefix with all the data being output
            that match the specified
            prefix.</p>
</div>

      
      
      
      <div class="section"><h2 class="title sectiontitle">Partial selection with compound keys</h2><p class="p">Compound keys, such as arrays
            or hashes, can also be specified in the view output, and the matching precedence can be
            used to provide complex selection ranges. For example, if time data is emitted in the
            following
            format:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">[year,month,day,hour,minute]
</samp></code></pre>
<p class="p">Then
            precise date (and time) ranges can be selected by specifying the date and time in the
            generated data. For example, to get information between 1st April 2011, 00:00 and 30th
            September 2011,
            23:59:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">?startkey=[2011,4,1,0,0]&amp;endkey=[2011,9,30,23,59]
</samp></code></pre>
<p class="p">The
            flexible structure and nature of the <samp class="ph codeph">startkey</samp> and
               <samp class="ph codeph">endkey</samp> values enable selection through a variety of range
            specifications. For example, you can obtain all of the data from the beginning of the
            year until the 5th March
            using:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">?startkey=[2011]&amp;endkey=[2011,3,5,23,59]
</samp></code></pre>
<p class="p">You
            can also examine data from a specific date through to the end of the
            month:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">?startkey=[2011,3,16]&amp;endkey=[2011,3,99]
</samp></code></pre>
<p class="p">In
            the above example, the value for the <samp class="ph codeph">day</samp> element of the array is an
            impossible value, but the matching algorithm will identify when the emitted value is
            lexically greater than the supplied <samp class="ph codeph">endkey</samp> value, and information
            selected for output will be stopped.</p>
<p class="p">A limitation of this structure is that it is
            not possible to ignore the earlier array values. For example, to select information from
            10am to 2pm each day, you cannot use this parameter
            set:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">?startkey=[null,null,null,10,0]&amp;endkey=[null,null,null,14,0]
</samp></code></pre>
<p class="p">In
            addition, because selection is made by a outputting a range of values based on the start
            and end key, you cannot specify range values for the date portion of the
            query:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">?startkey=[0,0,0,10,0]&amp;endkey=[9999,99,99,14,0]
</samp></code></pre>
<p class="p">This
            will instead output all the values from the first day at 10am to the last day at
            2pm.</p>
</div>

      
      
      
      <div class="section"><h2 class="title sectiontitle">Pagination</h2><p class="p">Pagination over results can be achieved by using the
               <samp class="ph codeph">skip</samp> and <samp class="ph codeph">limit</samp> parameters. For example, to get the
            first 10 records from the
            view:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">?limit=10
</samp></code></pre>
<p class="p">The next ten records can
            obtained by
            specifying:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">?skip=10&amp;limit=10
</samp></code></pre>
<p class="p">On the
            server, the <samp class="ph codeph">skip</samp> option works by executing the query and literally
            iterating over the specified number of output records specified by
            <samp class="ph codeph">skip</samp>, then returning the remainder of the data up until the specified
               <samp class="ph codeph">limit</samp> records are reached, if the <samp class="ph codeph">limit</samp> parameter
            is specified.</p>
<p class="p">When paginating with larger values for <samp class="ph codeph">skip</samp>, the
            overhead for iterating over the records can be significant. A better solution is to
            track the document id output by the first query (with the <samp class="ph codeph">limit</samp>
            parameter). You can then use <samp class="ph codeph">startkey_docid</samp> to specify the last
            document ID seen, skip over that record, and output the next ten
            records.</p>
<p class="p">Therefore, the paging sequence is, for the first
            query:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">?startkey="carrots"&amp;limit=10
</samp></code></pre>
<p class="p">Record
            the last document ID in the generated output, then
            use:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">?startkey="carrots"&amp;startkey_docid=DOCID&amp;skip=1&amp;limit=10
</samp></code></pre>
<p class="p">When
            using <samp class="ph codeph">startkey_docid</samp> you must specify the <samp class="ph codeph">startkey</samp>
            parameter to specify the information being searched for. By using the
               <samp class="ph codeph">startkey_docid</samp> parameter, Couchbase Server skips through the B-Tree
            index to the specified document ID. This is much faster than the skip/limit example
            shown
            above.</p>
</div>

      
      
      
      <div class="section"><h2 class="title sectiontitle">Grouping in queries</h2><p class="p">If you have specified an array as your compound
            key within your view, then you can specify the group level to be applied to the query
            output when using a <samp class="ph codeph">reduce()</samp>.</p>
<p class="p">When grouping is enabled, the view
            output is grouped according to the key array, and you can specify the level within the
            defined array that the information is grouped by. You do this by specifying the index
            within the array by which you want the output grouped using the
               <samp class="ph codeph">group_level</samp> parameter.</p>

         
         <div class="fig fignone">
            <img class="image" src="../images/views-grouping.png" width="480" alt="">
            </div>

         
         <p class="p">The <samp class="ph codeph">group_level</samp> parameter specifies the
            array index (starting at 1) at which you want the grouping occur, and generate a unique
            value based on this value that is used to identify all the items in the view output that
            include this unique value:</p>
<ul class="ul">
            <li class="li"><p class="p">A group level of <samp class="ph codeph">0</samp> groups by the entire dataset (as if no array
                  exists).</p>
</li>

            <li class="li"><p class="p">A group level of <samp class="ph codeph">1</samp> groups the content by the unique value of the
                  first element in the view key array. For example, when outputting a date split by
                  year, month, day, hour, minute, each unique year will be output.</p>
</li>

            <li class="li"><p class="p">A group level of <samp class="ph codeph">2</samp> groups the content by the unique value of the
                  first and second elements in the array. With a date, this outputs each unique year
                  and month, including all records with that year and month into each
               group.</p>
</li>

            <li class="li"><p class="p">A group level of <samp class="ph codeph">3</samp> groups the content by the unique value of the
                  first three elements of the view key array. In a date this outputs each unique
                  date (year, month, day) grouping all items according to these first three
                  elements.</p>
</li>

         </ul>
<p class="p">The grouping will work for any output structure where you have output an compound
            key using an array as the output value for the
            key.</p>
</div>

      
      
      
      <div class="section"><h2 class="title sectiontitle">Selection when grouping</h2><p class="p">When using grouping and selection using the
               <samp class="ph codeph">key</samp>, <samp class="ph codeph">keys</samp>, or <samp class="ph codeph">startkey</samp> /
               <samp class="ph codeph">endkey</samp> parameters, the query value should match at least the format
            (and element count) of the group level that is being queried.</p>
<p class="p">For example, using
            the following <samp class="ph codeph">map()</samp> function to output information by date as an
            array:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">function(doc, meta)
{
  emit([doc.year, doc.mon, doc.day], doc.logtype);
}
</samp></code></pre>
<p class="p">If
            you specify a <samp class="ph codeph">group_level</samp> of <samp class="ph codeph">2</samp> then you must specify a
            key using at least the year and month information. For example, you can specify an
            explicit key, such as <samp class="ph codeph">[2012,8]</samp>
            :</p>
<pre class="pre codeblock"><code><samp class="ph codeph">?group=true&amp;group_level=2&amp;key=[2012,8]
</samp></code></pre>
<p class="p">You
            can query it for a
            range:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">?group=true&amp;group_level=2&amp;startkey=[2012,2]&amp;endkey=[2012,8]
</samp></code></pre>
<p class="p">You
            can also specify a year, month and day, while still grouping at a higher level. For
            example, to group by year/month while selecting by specific
            dates:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">?group=true&amp;group_level=2&amp;startkey=[2012,2,15]&amp;endkey=[2012,8,10]
</samp></code></pre>
<p class="p">Specifying
            compound keys that are shorter than the specified group level may output unexpected
            results due to the selection mechanism and the way <samp class="ph codeph">startkey</samp> and
               <samp class="ph codeph">endkey</samp> are used to start and stop the selection of output
            rows.</p>
</div>

      
      
      
      <div class="section" id="topic21758__ordering"><h2 class="title sectiontitle">Ordering</h2><p class="p">All view results are automatically output sorted, with the
            sorting based on the content of the key in the output view. Views are sorted using a
            specific sorting format, with the basic order for all basic and compound follows as
            follows:</p>
<ul class="ul">
            <li class="li"><p class="p"><samp class="ph codeph">null</samp></p>
</li>

            <li class="li"><p class="p"><samp class="ph codeph">false</samp></p>
</li>

            <li class="li"><p class="p"><samp class="ph codeph">true</samp></p>
</li>

            <li class="li"><p class="p">Numbers</p>
</li>

            <li class="li"><p class="p">Text (case sensitive, lowercase first, UTF–8 order)</p>
</li>

            <li class="li"><p class="p">Arrays (according to the values of each element, in order)</p>
</li>

            <li class="li"><p class="p">Objects (according to the values of keys, in key order)</p>
</li>

         </ul>
<p class="p">The natural sorting is therefore by default close to natural sorting order both
            alphabetically (A-Z) and numerically (0–9).</p>
<p class="p">There is no collation or foreign
            language support. Sorting is always according to the above rules based on UTF–8
            values.</p>
<p class="p">You can alter the direction of the sorting (reverse, highest to lowest
            numerically, Z-A alphabetically) by using the <samp class="ph codeph">descending</samp> option. When
            set to true, this reverses the order of the view results, ordered by their
            key.</p>
<p class="p">Because selection is made after sorting the view results, if you configure
            the results to be sorted in descending order and you are selecting information using a
            key range, then you must also reverse the <samp class="ph codeph">startkey</samp> and
               <samp class="ph codeph">endkey</samp> parameters. For example, if you query ingredients where the
            start key is ‘tomato’ and the end key is ‘zucchini’, for
            example:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">?startkey="tomato"&amp;endkey="zucchini"
</samp></code></pre>
<p class="p">The
            selection will operate, returning information when the first key matches ‘tomato’ and
            stopping on the last key that matches ‘zucchini’.</p>
<p class="p">If the return order is
            reversed:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">?descending=true&amp;startkey="tomato"&amp;endkey="zucchini"
</samp></code></pre>
<p class="p">The
            query will return only entries matching ‘tomato’. This is because the order will be
            reversed, ‘zucchini’ will appear first, and it is only when the results contain ‘tomato’
            that any information is returned.</p>
<p class="p">To get all the entries that match, the
               <samp class="ph codeph">startkey</samp> and <samp class="ph codeph">endkey</samp> values must also be
            reversed:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">?descending=true&amp;startkey="zucchini"&amp;endkey="tomato"
</samp></code></pre>
<p class="p">The
            above selection will start generating results when ‘zucchini’ is identified in the key,
            and stop returning results when ‘tomato’ is identified in the key.</p>
<p class="p">View output and
            selection are case sensitive. Specifying the key ‘Apple’ will not return ‘apple’ or
            ‘APPLE’ or other case differences. Normalizing the view output and query input to all
            lowercase or upper case will simplify the process by eliminating the case
            differences.</p>
</div>

      
      
      
      <div class="section"><h2 class="title sectiontitle">Understanding letter ordering in views</h2><p class="p">Couchbase Server uses a
            Unicode collation algorithm to order letters, so you should be aware of how this
            functions. Most developers are typically used to Byte order, such as that found in ASCII
            and which is used in most programming languages for ordering strings during string
            comparisons.</p>
<p class="p">The following shows the order of precedence used in Byte order, such
            as ASCII:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">123456890 &lt; A-Z &lt; a-z
</samp></code></pre>
<p class="p">This
            means any items that start with integers will appear before any items with letters; any
            items that beginning with capital letters will appear before items in lower case
            letters. This means the item named “Apple” will appear before “apple” and the item
            “Zebra” will appear before “apple”. Compare this with the order of precedence used in
            Unicode collation, which is used in Couchbase
            Server:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">123456790 &lt; aAbBcCdDeEfFgGhH...
</samp></code></pre>
<p class="p">Notice
            again that items that start with integers will appear before any items with letters.
            However, in this case, the lowercase and then uppercase of the same letter are grouped
            together. This means that that if “apple” will appear before “Apple” and would also
            appear before “Zebra.” In addition, be aware that with accented characters will follow
            this
            ordering:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">a &lt; á &lt; A &lt; Á &lt; b
</samp></code></pre>
<p class="p">This
            means that all items starting with “a” <em class="ph i">and accented variants of the letter</em> will
            occur before “A” and any accented variants of “A.”</p>
<p class="p"><strong class="ph b">Ordering
            Example</strong></p>
<p class="p">In Byte order, keys in an index would appear as
            follows:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">"ABC123" &lt; "ABC223" &lt; "abc123" &lt; "abc223" &lt; "abcd23" &lt; "bbc123" &lt; "bbcd23"
</samp></code></pre>
<p class="p">The
            same items will be ordered this way by Couchbase Server under Unicode
            collation:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">"abc123" &lt; "ABC123" &lt; "abc223" &lt; "ABC223" &lt; "abcd23" &lt; "bbc123" &lt; "bbcd23"
</samp></code></pre>
<p class="p">This
            is particularly important for you to understand if you query Couchbase Server with a
               <samp class="ph codeph">startkey</samp> and <samp class="ph codeph">endkey</samp> to get back a range of results.
            The items you would retrieve under Byte order are different compared to Unicode
            collation. </p>

         
         <p class="p"><strong class="ph b">Ordering and Query Example</strong></p>
<p class="p">This
            following example demonstrates Unicode collation in Couchbase Server and the impact on
            query results returned with a <samp class="ph codeph">startkey</samp> and <samp class="ph codeph">endkey</samp>. It
            is based on the <samp class="ph codeph">beer-sample</samp> database provided with Couchbase Server.
            </p>
<p class="p">Imagine you want to retrieve all breweries with names starting
            with uppercase Y. Your query parameters would appear as
            follows:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">startkey="Y"&amp;endkey="z"
</samp></code></pre>
<p class="p">If
            you want breweries starting with lowercase y <em class="ph i">or</em> uppercase Y, you would provides a
            query as
            follows:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">startkey="y"&amp;endkey="z"
</samp></code></pre>
<p class="p">This
            will return all names with lower case Y and items up to, but not including lowercase z,
            thereby including uppercase Y as well. To retrieve the names of breweries starting with
            lowercase y only, you would terminate your range with capital
            Y:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">startkey="y"&amp;endkey="Y"
</samp></code></pre>
<p class="p">As it
            happens, the sample database does not contain any results because there are no beers in
            it which start with lowercase <samp class="ph codeph">y</samp>.</p>
</div>

      
      
      
      <div class="section"><h2 class="title sectiontitle">Error control</h2><p class="p">There are a number of parameters that can be used to
            help control errors and responses during a view query.</p>
<ul class="ul">
            <li class="li"><samp class="ph codeph">on_error</samp></li>

         </ul>
<p class="p">The <samp class="ph codeph">on_error</samp> parameter specifies whether the view results will be
            terminated on the first error from a node, or whether individual nodes can fail and
            other nodes return information.</p>
<p class="p">When returning the information generated by a view
            request, the default response is for any raised error to be included as part of the JSON
            response, but for the view process to continue. This permits for individual nodes within
            the Couchbase cluster to timeout or fail, while still generating the requested view
            information.</p>
<p class="p">In this instance, the error is included as part of the JSON
            returned:</p>

         
         <pre class="pre codeblock"><code>
{
   "errors" : [
      {
         "from" : "http://192.168.1.80:9503/_view_merge/?stale=false",
         "reason" : "req_timedout"
      },
      {
         "from" : "http://192.168.1.80:9502/_view_merge/?stale=false",
         "reason" : "req_timedout"
      },
      {
         "from" : "http://192.168.1.80:9501/_view_merge/?stale=false",
         "reason" : "req_timedout"
      }
   ],
   "rows" : [
      {
         "value" : 333280,
         "key" : null
      }
   ]
}
</code></pre>

         <p class="p">You
            can alter this behavior by using the <samp class="ph codeph">on_error</samp> argument. The default
            value is <samp class="ph codeph">continue</samp>. If you set this value to <samp class="ph codeph">stop</samp> then
            the view response will cease the moment an error occurs. The returned JSON will contain
            the error information for the node that returned the first error. For
         example:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">```
{
   "errors" : [
      {
         "from" : "http://192.168.1.80:9501/_view_merge/?stale=false",
         "reason" : "req_timedout"
      }
   ],
   "rows" : [
      {
         "value" : 333280,
         "key" : null
      }
   ]
}
```
</samp></code></pre>
</div>

      
      
      
   </div>

   <nav class="related-links"><h2>Related information</h2>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="../Views/views-intro.html" title="Couchbase views enable indexing and querying of data.">Views and indexes</a></div>
<div class="previouslink"><strong>Previous topic:</strong> <a class="link" href="../Views/views-translateSQL.html" title="This section provides information on how to translate SQL to a map/reduce environment.">Translating SQL to map/reduce</a></div>
<div class="nextlink"><strong>Next topic:</strong> <a class="link" href="../Views/views-querySample.html" title="This section provides general information and query examples.">View and query examples</a></div>
</div>

<div class="linklist linklist">
<div><a class="link" href="views-writing.html" title="During the view creation process, the output structure, field order, content, and any summary or grouping information desired in the view is defined.">Writing views</a></div>
<div><a class="link" href="views-querySample.html" title="This section provides general information and query examples.">View and query examples</a></div>
<div><a class="link" href="../REST/rest-views-intro.html" title="The Views REST API is used to index and query JSON documents.">Views API</a></div>
<div><a class="link" href="http://www.unicode.org/reports/tr10/" target="_blank">Unicode Technical Standard #10</a></div>
<div><a class="link" href="http://userguide.icu-project.org/collation/customization#TOC-Default-Options/" target="_blank">ICU User Guide, Customization, Default Options</a></div></div>
</nav>
</div><footer class="developer-portal-footer" role="contentinfo"><p class="legal"><span class="license">© 2011–2015 <b class="company-name">Couchbase</b> All rights reserved.</span><a href="http://www.couchbase.com/developers">Developer Portal</a><a href="http://forums.couchbase.com">Forums</a><a href="http://www.couchbase.com/downloads">Download</a><a href="http://support.couchbase.com/">Customer Support Login</a></p></footer></div></main><script src="../assets/javascripts/vendor/prism.js"></script><script type="text/javascript">var BASEPATH='../';</script><script src="../assets/javascripts/init.js"></script><script type="text/javascript" src="https://issues.couchbase.com/s/en_US-pvmaib-418945332/845/131/1.2.9/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?collectorId=86389172"></script></body></html>